<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8" />
    <title>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå + Drag & Drop</title>
    <style>
        body {
            font-family: "Sarabun", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #f7f9fc;
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 30px;
            font-weight: 700;
            color: #2c3e50;
            text-align: center;
            user-select: none;
        }

        .summary {
            display: flex;
            gap: 24px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .box {
            background: white;
            padding: 18px 28px;
            border-radius: 14px;
            box-shadow: 0 4px 8px rgb(0 0 0 / 0.08);
            min-width: 180px;
            font-weight: 600;
            font-size: 1.15rem;
            text-align: center;
            color: #34495e;
            user-select: none;
            transition: background-color 0.3s ease;
        }
        .box:hover {
            background-color: #e8f0fe;
        }

        /* ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏ô‡∏™‡∏∏‡∏î */
        .top-controls {
            width: 100%;
            max-width: 900px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .filter-container {
            min-width: 160px;
            user-select: none;
        }
        label {
            font-weight: 600;
            margin-bottom: 6px;
            display: block;
            color: #34495e;
            font-size: 1rem;
        }
        select {
            width: 100%;
            padding: 8px 12px;
            font-size: 1rem;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
            transition: border-color 0.25s ease;
        }
        select:hover, select:focus {
            border-color: #1d6fa5;
            outline: none;
        }

        #delete-selected {
            padding: 10px 24px;
            font-size: 1.1rem;
            font-weight: 700;
            background-color: #e74c3c;
            border: none;
            border-radius: 9px;
            color: white;
            cursor: pointer;
            transition: background-color 0.25s ease;
            user-select: none;
            white-space: nowrap;
            flex-shrink: 0;
        }
        #delete-selected:disabled {
            background-color: #c0392b;
            cursor: not-allowed;
            opacity: 0.6;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            max-width: 900px;
            background: white;
            box-shadow: 0 5px 15px rgb(0 0 0 / 0.1);
            border-radius: 10px;
            overflow: hidden;
            user-select: none;
        }
        thead {
            background: #3498db;
            color: white;
            font-weight: 700;
        }
        th, td {
            padding: 14px 18px;
            border-bottom: 1px solid #ddd;
            text-align: center;
            font-size: 1rem;
        }
        tbody tr:hover {
            background-color: #f1f7ff;
        }

        .online {
            color: #27ae60;
            font-weight: 700;
        }
        .offline {
            color: #c0392b;
            font-weight: 700;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î style ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å */
        tbody tr.dragging {
            opacity: 0.5;
            background-color: #dceeff !important;
        }
        tbody tr.drag-over {
            border-top: 3px solid #3498db;
        }

        /* Custom Alert/Popup */
        .custom-alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            max-width: 80%;
            text-align: center;
            font-size: 1.1rem;
        }
        .custom-alert.show {
            opacity: 1;
        }

        /* --- Custom Confirmation Modal Styles --- */
        .custom-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1001; /* Sit on top of everything */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
            padding-top: 50px; /* Offset from top */
        }

        .custom-modal.show {
            display: flex; /* Show when active */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px;
            text-align: center;
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.3s ease-out;
        }

        .custom-modal.show .modal-content {
            transform: scale(1);
            opacity: 1;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #2c3e50;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .modal-content p {
            font-size: 1.1rem;
            color: #555;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .modal-button {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
            white-space: nowrap;
        }

        .modal-button.confirm {
            background-color: #e74c3c;
            color: white;
        }
        .modal-button.confirm:hover {
            background-color: #c0392b;
            transform: translateY(-2px);
        }

        .modal-button.cancel {
            background-color: #bdc3c7;
            color: #34495e;
        }
        .modal-button.cancel:hover {
            background-color: #95a5a6;
            transform: translateY(-2px);
        }

        @media (max-width: 600px) {
            .summary {
                flex-direction: column;
                gap: 15px;
                align-items: center;
            }
            .box {
                width: 100%;
                max-width: 300px;
            }
            .top-controls {
                flex-direction: column;
                align-items: stretch;
            }
            #delete-selected {
                width: 100%;
            }
            table {
                max-width: 100%;
            }
            .modal-content {
                padding: 20px;
            }
            .modal-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

    <h1>üìä ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏ó‡∏°‡πå (‡∏•‡∏≤‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÑ‡∏î‡πâ)</h1>

    <div class="summary">
        <div class="box" id="total-cash">üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: -</div>
        <div class="box" id="total-money">üíµ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó: -</div>
        <div class="box" id="online-count">üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: -</div>
        <div class="box" id="offline-count">üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: -</div>
    </div>

    <div class="top-controls">
        <div class="filter-container">
            <label for="status-filter">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô</label>
            <select id="status-filter" aria-label="‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô">
                <option value="all" selected>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                <option value="online">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</option>
                <option value="offline">‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå</option>
            </select>
        </div>

        <div class="filter-container">
            <label for="sort-cash">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏¥‡∏ô</label>
            <select id="sort-cash" aria-label="‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏¥‡∏ô">
                <option value="none" selected>‡πÑ‡∏°‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏á</option>
                <option value="desc">‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢</option>
                <option value="asc">‡∏ô‡πâ‡∏≠‡∏¢‡πÑ‡∏õ‡∏°‡∏≤‡∏Å</option>
            </select>
        </div>

        <button id="delete-selected" disabled>‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</button>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 40px;">#</th>
                <th style="width: 36px;"><input type="checkbox" id="select-all" title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" /></th>
                <th>üßë Username</th>
                <th>üí∏ Cash</th>
                <th>üë• Player Count</th>
                <th>üì∂ Status</th>
                <th>üïí Last Online</th>
            </tr>
        </thead>
        <tbody id="player-table" draggable="false">
        </tbody>
    </table>

    <div id="confirm-modal" class="custom-modal">
        <div class="modal-content">
            <h3 id="modal-title">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p id="modal-message">‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô **X** ‡∏Ñ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ</p>
            <div class="modal-buttons">
                <button class="modal-button cancel" id="modal-cancel">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button class="modal-button confirm" id="modal-confirm">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö</button>
            </div>
        </div>
    </div>

    <script>
        const supabaseUrl = "https://inlrteqmzgrnhzibkymh.supabase.co";
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ Supabase Key ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå 'delete' ‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'players'
        const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlubHJ0ZXFtemdybmh6aWJreW1oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ4NDMwNjUsImV4cCI6MjA2MDQxOTA2NX0.fHKi5Cy0RfO65OVedadzCTUi26MTSPN5nKs92zNyYFU";

        const headers = {
            apikey: supabaseKey,
            Authorization: `Bearer ${supabaseKey}`,
            Accept: "application/json",
            "Content-Type": "application/json",
        };

        let playersData = [];
        let currentFilter = "all";
        let currentSort = "none";

        const playerTable = document.getElementById("player-table");
        const totalCashEl = document.getElementById("total-cash");
        const totalMoneyEl = document.getElementById("total-money");
        const onlineCountEl = document.getElementById("online-count");
        const offlineCountEl = document.getElementById("offline-count");

        const statusFilter = document.getElementById("status-filter");
        const sortCashSelect = document.getElementById("sort-cash");
        const deleteBtn = document.getElementById("delete-selected");
        const selectAllCheckbox = document.getElementById("select-all");

        // Custom Modal Elements
        const confirmModal = document.getElementById("confirm-modal");
        const modalTitle = document.getElementById("modal-title");
        const modalMessage = document.getElementById("modal-message");
        const modalConfirmBtn = document.getElementById("modal-confirm");
        const modalCancelBtn = document.getElementById("modal-cancel");

        let confirmCallback = null; // Store the function to call on confirm

        function formatMoney(cash) {
            return (cash / 1000000 * 100).toFixed(2) + " ‡∏ö‡∏≤‡∏ó";
        }

        // Function to show a custom alert message
        function showCustomAlert(message, duration = 5000) {
            let alertBox = document.querySelector(".custom-alert");
            if (!alertBox) {
                alertBox = document.createElement("div");
                alertBox.classList.add("custom-alert");
                document.body.appendChild(alertBox);
            }
            alertBox.textContent = message;
            alertBox.classList.add("show");

            setTimeout(() => {
                alertBox.classList.remove("show");
            }, duration);
        }

        // Function to show custom confirmation modal
        function showConfirmModal(title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.innerHTML = message; // Using innerHTML for bold formatting
            confirmCallback = onConfirm;
            confirmModal.classList.add("show");
        }

        // Event listeners for custom confirmation modal buttons
        modalConfirmBtn.onclick = () => {
            if (confirmCallback) {
                confirmCallback(true);
            }
            confirmModal.classList.remove("show");
            confirmCallback = null; // Clear callback
        };

        modalCancelBtn.onclick = () => {
            if (confirmCallback) {
                confirmCallback(false);
            }
            confirmModal.classList.remove("show");
            confirmCallback = null; // Clear callback
        };

        // Close modal if click outside (optional)
        confirmModal.onclick = (e) => {
            if (e.target === confirmModal) {
                if (confirmCallback) {
                    confirmCallback(false); // Treat as cancel if clicking outside
                }
                confirmModal.classList.remove("show");
                confirmCallback = null;
            }
        };


        async function fetchPlayers() {
            console.log("üì° ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏à‡∏≤‡∏Å Supabase...");
            try {
                const res = await fetch(`${supabaseUrl}/rest/v1/players?select=*&order=username.asc`, {
                    headers,
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Error: ${res.status} ${res.statusText} - ${errorText}`);
                }
                const data = await res.json();
                playersData = data;
                console.log("‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", playersData.length, "‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô");
                renderPlayers();
            } catch (error) {
                console.error("‚ùå ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
                showCustomAlert("‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: " + error.message, 8000); // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏ô‡∏≤‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
            }
        }

        function applyFilterAndSort(data) {
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            let filtered = data.filter(p => {
                if (currentFilter === "online") return p.status === "online";
                if (currentFilter === "offline") return p.status !== "online";
                return true;
            });

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏á‡∏¥‡∏ô
            if (currentSort === "desc") {
                filtered.sort((a, b) => (b.cash || 0) - (a.cash || 0));
            } else if (currentSort === "asc") {
                filtered.sort((a, b) => (a.cash || 0) - (b.cash || 0));
            }

            return filtered;
        }

        function renderPlayers() {
            playerTable.innerHTML = "";
            let totalCash = 0;
            let online = 0;
            let offline = 0;

            let filteredPlayers = applyFilterAndSort(playersData);

            filteredPlayers.forEach((player, index) => {
                const username = player.username || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠";
                const cash = player.cash || 0;
                const playercount = player.playercount ?? "-";
                const status = player.status === "online" ? "‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå" : "‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå";
                const statusClass = player.status === "online" ? "online" : "offline";
                const lastOnline = player.last_online ? new Date(player.last_online).toLocaleString() : "-";

                totalCash += cash;
                if (player.status === "online") online++;
                else offline++;

                const tr = document.createElement("tr");
                tr.setAttribute("draggable", "true");
                tr.dataset.username = username; // ‡πÄ‡∏Å‡πá‡∏ö username ‡πÉ‡∏ô dataset

                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td><input type="checkbox" class="row-checkbox" data-username="${username}" aria-label="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username}" /></td>
                    <td>${username}</td>
                    <td>${cash.toLocaleString()}</td>
                    <td>${playercount}</td>
                    <td class="${statusClass}">${status}</td>
                    <td>${lastOnline}</td>
                `;
                playerTable.appendChild(tr);
            });

            totalCashEl.innerText = `üí∞ ‡πÄ‡∏á‡∏¥‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalCash.toLocaleString()}`;
            totalMoneyEl.innerText = `üíµ ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏≤‡∏ó: ${formatMoney(totalCash)}`;
            onlineCountEl.innerText = `üü¢ ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: ${online}`;
            offlineCountEl.innerText = `üî¥ ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå: ${offline}`;

            updateDeleteButtonState();
            updateSelectAllState();
            addCheckboxListeners();
            addDragAndDropListeners();
            checkPlayerStatusOnline();
        }

        async function updatePlayerStatus(username, status) {
            console.log(`‚ÑπÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} ‡πÄ‡∏õ‡πá‡∏ô ${status}...`);
            try {
                const res = await fetch(`${supabaseUrl}/rest/v1/players?username=eq.${encodeURIComponent(username)}`, {
                    method: "PATCH",
                    headers,
                    body: JSON.stringify({ status: status }),
                });
                if (!res.ok) {
                    const errorText = await res.text();
                    throw new Error(`Error: ${res.status} ${res.statusText} - ${errorText}`);
                }
                console.log(`‚úÖ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${username} ‡πÄ‡∏õ‡πá‡∏ô ${status} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                await fetchPlayers();
            } catch (error) {
                console.error(`‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${username} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:`, error);
                showCustomAlert(`‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ ${username} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}`, 8000);
            }
        }

        function checkPlayerStatusOnline() {
            const now = new Date();
            console.log("‚è±Ô∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå...");

            playersData.forEach(player => {
                const username = player.username;
                const lastOnlineStr = player.last_online;
                const status = player.status;

                if (status === "online" && lastOnlineStr) {
                    const lastOnlineTime = new Date(lastOnlineStr);
                    const diffSeconds = (now.getTime() - lastOnlineTime.getTime()) / 1000;

                    console.log(`Debug: ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} | ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${status} | last_online: ${lastOnlineStr} | ‡πÄ‡∏ß‡∏•‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏õ: ${diffSeconds.toFixed(2)} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ`);

                    if (diffSeconds > 30) {
                        console.warn(`üö® ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} ‡πÑ‡∏°‡πà‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö 30 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ! ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô offline...`);
                        updatePlayerStatus(username, "offline");
                    }
                } else if (status === "online" && !lastOnlineStr) {
                    console.warn(`‚ö†Ô∏è ‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ last_online. ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏õ‡πá‡∏ô offline...`);
                    updatePlayerStatus(username, "offline");
                }
            });
        }

        function updateDeleteButtonState() {
            const anyChecked = !!document.querySelector(".row-checkbox:checked");
            deleteBtn.disabled = !anyChecked;
            console.log(`Debug: ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${deleteBtn.disabled ? 'Disabled' : 'Enabled'}`);
        }

        function updateSelectAllState() {
            const checkboxes = document.querySelectorAll(".row-checkbox");
            const checkedBoxes = document.querySelectorAll(".row-checkbox:checked");
            selectAllCheckbox.checked = checkboxes.length > 0 && checkboxes.length === checkedBoxes.length;
            selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < checkboxes.length;
        }

        function addCheckboxListeners() {
            const checkboxes = document.querySelectorAll(".row-checkbox");
            checkboxes.forEach(cb => {
                cb.onchange = () => {
                    updateDeleteButtonState();
                    updateSelectAllState();
                };
            });
        }

        statusFilter.onchange = () => {
            currentFilter = statusFilter.value;
            renderPlayers();
        };

        sortCashSelect.onchange = () => {
            currentSort = sortCashSelect.value;
            renderPlayers();
        };

        selectAllCheckbox.onchange = () => {
            const checkboxes = document.querySelectorAll(".row-checkbox");
            checkboxes.forEach(cb => {
                cb.checked = selectAllCheckbox.checked;
            });
            updateDeleteButtonState();
            updateSelectAllState();
        };

        async function performDelete(checkedBoxes) {
            console.log(`üóëÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${checkedBoxes.length} ‡∏Ñ‡∏ô...`);
            let successCount = 0;
            let failedUsers = [];

            for (const cb of checkedBoxes) {
                const username = cb.getAttribute("data-username");
                console.log(`‚öôÔ∏è ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô: ${username}`);
                try {
                    const res = await fetch(`${supabaseUrl}/rest/v1/players?username=eq.${encodeURIComponent(username)}`, {
                        method: "DELETE",
                        headers,
                    });

                    if (res.status === 204) {
                        console.log(`‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                        successCount++;
                    } else {
                        const errorText = await res.text();
                        const errorMessage = errorText || `‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞: ${res.status} ${res.statusText}`;
                        console.error(`‚ùå ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${errorMessage}. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Supabase RLS/‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå`, res);
                        failedUsers.push(`${username} (‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${errorMessage})`);
                    }
                } catch (error) {
                    console.error(`‚ùå ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô ${username} ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß (Network/Fetch Error):`, error);
                    failedUsers.push(`${username} (‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢: ${error.message})`);
                }
            }

            let message = "";
            if (failedUsers.length === 0) {
                message = `‚úÖ ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${successCount} ‡∏Ñ‡∏ô`;
            } else {
                message = `‚ö†Ô∏è ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${successCount} ‡∏Ñ‡∏ô\n‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ${failedUsers.length} ‡∏Ñ‡∏ô:\n- ${failedUsers.join("\n- ")}\n\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå (RLS) ‡πÉ‡∏ô Supabase Dashboard`;
            }
            showCustomAlert(message, 7000);

            console.log("‚ÑπÔ∏è ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î...");
            await fetchPlayers();
        }

        deleteBtn.onclick = () => {
            const checkedBoxes = [...document.querySelectorAll(".row-checkbox:checked")];
            if (checkedBoxes.length === 0) {
                showCustomAlert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö", 3000);
                return;
            }

            const playerCount = checkedBoxes.length;
            const message = `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô **${playerCount}** ‡∏Ñ‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`;

            showConfirmModal("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•", message, (confirmed) => {
                if (confirmed) {
                    performDelete(checkedBoxes);
                } else {
                    console.log("‚ÑπÔ∏è ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö.");
                }
            });
        };

        // --- Drag & Drop ---

        let draggedRow = null;

        function addDragAndDropListeners() {
            const rows = playerTable.querySelectorAll("tr");
            rows.forEach(row => {
                row.removeEventListener("dragstart", onDragStart);
                row.removeEventListener("dragover", onDragOver);
                row.removeEventListener("drop", onDrop);
                row.removeEventListener("dragend", onDragEnd);

                row.addEventListener("dragstart", onDragStart);
                row.addEventListener("dragover", onDragOver);
                row.addEventListener("drop", onDrop);
                row.addEventListener("dragend", onDragEnd);
            });
        }

        function onDragStart(e) {
            draggedRow = e.currentTarget;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', null);
            draggedRow.classList.add("dragging");
            console.log(`‚ÑπÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏Å: ${draggedRow.dataset.username}`);
        }

        function onDragOver(e) {
            e.preventDefault();
            const target = e.currentTarget;
            if (target === draggedRow) return;

            playerTable.querySelectorAll("tr").forEach(tr => {
                tr.classList.remove("drag-over");
                tr.style.borderTop = "";
                tr.style.borderBottom = "";
            });

            const bounding = target.getBoundingClientRect();
            const offset = e.clientY - bounding.top;

            if (offset < bounding.height / 2) {
                target.classList.add("drag-over");
                target.style.borderTop = "3px solid #3498db";
            } else {
                target.classList.add("drag-over");
                target.style.borderBottom = "3px solid #3498db";
            }
        }

        function onDrop(e) {
            e.preventDefault();
            const target = e.currentTarget;
            if (target === draggedRow) return;

            const bounding = target.getBoundingClientRect();
            const offset = e.clientY - bounding.top;

            playerTable.querySelectorAll("tr").forEach(tr => {
                tr.classList.remove("drag-over");
                tr.style.borderTop = "";
                tr.style.borderBottom = "";
            });

            if (offset < bounding.height / 2) {
                playerTable.insertBefore(draggedRow, target);
            } else {
                playerTable.insertBefore(draggedRow, target.nextSibling);
            }
            updateRowNumbers();
            console.log(`‚úÖ ‡∏ß‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${draggedRow.dataset.username} ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà`);
        }

        function onDragEnd(e) {
            draggedRow.classList.remove("dragging");
            playerTable.querySelectorAll("tr").forEach(tr => {
                tr.classList.remove("drag-over");
                tr.style.borderTop = "";
                tr.style.borderBottom = "";
            });
            draggedRow = null;
            console.log("‚ÑπÔ∏è ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å");
        }

        function updateRowNumbers() {
            const rows = playerTable.querySelectorAll("tr");
            rows.forEach((row, i) => {
                row.querySelector("td:first-child").textContent = i + 1;
            });
        }

        // --- Initial fetch and interval ---
        fetchPlayers();
        setInterval(fetchPlayers, 10000); // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏∏‡∏Å 10 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    </script>

</body>
</html>
